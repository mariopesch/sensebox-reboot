---
layout: project_page
title: "TTNv3 mit der senseBox"
date: 2021-02-19
author: Mario & Felix
abstract: "In diesem Projekt wird dir gezeigt wie du Messwerte auf die openSenseMap über TTN v3 überträgst"


thumbnail:  /images/projects/TTNv3/logo.png

material:
    - senseBox MCU
    - 1x LoRa-Bee
    - 1x beliebiger Sensor mit JST Kabel
    
ide: blockly
version: ["edu", "mini","home"]    
lang: de
tags: ["Informatik"]
difficult: mittel
---

<style>
img {
  max-width: 100%;
}
</style>
<head><title>TTN v3 mit der senseBox</title></head>

Das öffentliche The Things Network (TTN) migriert im Laufe des Jahres von Version 2 zu Version 3. Es gibt einige Neuigkeiten, unter anderem ein Single Sign-On (SSO) System, eine neue Oberfläche aber auch eine andere Datenstruktur. In diesem Projekt wollen wir zeigen, wie man (Stand Februar 2021) eine senseBox im neuen TTN registriert, in Blockly programmiert und seine Messwerte zur openSenseMap sendet.

### Application erstellen
Zunächst melden wir uns in der neuen TTNv3 Console an ([https://eu1.cloud.thethings.network/console/](https://eu1.cloud.thethings.network/console/)). Man kann dort die gleichen Login-Daten nutzen wie bei der alten Konsole. In den Applications erstellen wir eine neue Application und geben ihr eine beliebige ID.

![](/images/projects/TTNv3/add-application.png)


### Device erstellen
Daraufhin können wir in der Application unter "+ Add end Device" ein neues Device (also z.B. eine senseBox) hinzufügen.

Hier müssen wir oben **Manually** auswählen. Die Aktivierung kann **Over the air acitivation (OTAA)** bleiben und als LoRaWAN-Version nehmen wir **MAC V1.0.2**. Die restlichen Einstellungen bleiben wie gehabt.

![](/images/projects/TTNv3/register-device.png)


### EUIs
Im nächsten Schritt geben wir dem neuen Device eine ID und müssen die EUIs eintragen. Die AppEUI kann man über den Button mit Nullen füllen. Die DevEUI muss man aktuell noch selbst befüllen (wir haben hier einfach zufällige Werte einegtragen). Man kann aber auch z.B. die DevEUI von TTNv2 nehmen, wenn das Gerät vorher dort registriert war. Eine automatische Generierung einer DevEUI ist aber auch für TTNv3 geplant: [https://www.thethingsnetwork.org/forum/t/unable-to-generate-new-deveui-in-v3-console-known-issue/44486](https://www.thethingsnetwork.org/forum/t/unable-to-generate-new-deveui-in-v3-console-known-issue/44486)

![](/images/projects/TTNv3/register-device-euis.png)

### Netzwerkeinstellungen
Im nächsten Schritt müssen wir die Netzwerkeinstellungen vornehmen:

* Frequency Plan: **Europe 863-870 MHz (SF9 for RX2 - recommended)**
* Regional Parameters version: **PHY V1.0.2 REV A**

![](/images/projects/TTNv3/register-device-network.png)

### Join Settings
In den Join Settings lassen wir den AppKey generieren und fügen das Device der Application hinzu.

![](/images/projects/TTNv3/register-device-join-settings.png)

### Decoding
Wir haben nun erfolgreich ein neues Device erstellt. In diesem Tutorial wollen wir das Cayenne Payload Format nutzen. Deshalb müssen wir noch das Payload Format der Application für den Uplink auf **Cayenne LPP** umstellen.

![](/images/projects/TTNv3/application-cayenne.png)

## Blockly

Nun erstellen wir unseren Code für die senseBox MCU in Blockly. Die EUIs und den Key findet man in der Übersicht von seinem neuen Device in der TTNv3 Konsole.

**Beim Kopieren der EUIs und des Keys muss man darauf achten, das richtige Format (lsb, msb) zu nutzen. Außerdem muss man die geschweiften Klammern `{` und `}` selbst vor bzw. hinter die Hexadezimalzahlen setzen, da diese aktuell nicht mitkopiert werden**

Der Sketch kann jetzt kompiliert und wie gewohnt auf die senseBox MCU geladen werden. Nach dem Start der senseBox sollten nun in der TTNv3 Console unter "Live data" Datenpakete erscheinen, wenn die senseBox in Reichweite eines TTN Gateways ist.

![](/images/projects/TTNv3/blockly.png)

## openSenseMap

In der openSenseMap registrieren wir eine neue senseBox und wählen bei der Hardware eine **senseBox:edu** oder **Manuelle Konfiguration** mit den entprechenden angeschlossenen Sensoren aus. In den erweiterten Einstellungen aktiviert man The Things Network und setzt das Decoding Profile auf **Cayenne LPP (beta)**. Unter Application-ID und Device-ID trägt man die IDs der Application und des Devices ein, welche man vorher bei der jeweiligen Registrierung in der TTNv3 Konsole beliebig gesetzt hat, z.B. "my-new-application" oder "my-new-device". Ggf. muss noch das Cayenne LPP Phänomen für jeden entsprechenden Sensor angepasst werden.

![](/images/projects/TTNv3/osem-registrierung.png)

## Webhook

Im letzten Schritt müssen wir die Daten von TTN zur openSenseMap weiterleiten. Dazu fügen wir der TTN Application eine neue **Webhook** Integration hinzu. Nach einem Klick auf "+ Add webhook" wählen wir "Custom webhook" und geben der neuen Webhook eine ID, z.B. **osem**. Als Webhook Format wählen wir **JSON** und die Base URL für den Endpoint ist **https://ttn.opensensemap.org/v3**. Außerdem müssen wir **Uplink messages** aktivieren. Nun ganz unten auf "Add webhook" klicken und schon ist die Weiterleitung zur openSenseMap eingerichtet. Nach ein paar Minuten sollten die ersten Messwerte auf der openSenseMap zu sehen sein. 

![](/images/projects/TTNv3/webhook.png)